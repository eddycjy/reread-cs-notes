---
title: TCP
type: docs
---


# 2.2 TCP 

## 2.2.1 什么是 TCP

TCP 是一种面向连接的、可靠的字节流服务的单播协议，它在 OSI 模型中位处传输层，原始规范是 [RFC0793](https://tools.ietf.org/html/rfc793)。

### 2.2.1.1 什么是面向连接

指的是使用 TCP 的两个应用程序必须在它们可交换数据之前，通过相互联系来建立一个 TCP 连接。

就像你平时拨打一个电话号码，等待对方接听电话并说 “喂”，然后再说 “找谁”。这正是一个 TCP 连接的两个端点在互相通讯，需要互相通讯并确认存在后才能建立 TCP 连接。

### 2.2.1.2 什么是可靠的

- TCP 维持了一个强制的校验和，用于检测传送中引入的比特差错，如果一个无效检验和的报文段到底，TCP 将会丢弃它，并且不会发送任何的确认（ACK）。
- TCP 发送一组报文段时，会设置一个重传计时器，等待对方的确认接收。
- TCP 在接收到连接的另一端的数据时，会发送一个确认（ACK）作为表示自己接收到的标识。
- TCP 是全双工的，也就是说数据可以向两个方向流动。

### 2.2.1.3 什么是字节流

字节流是 TCP 中提供的一种抽象概念。

### 2.2.1.4 什么是单播协议

指的是信息的接受和传递只在两个节点进行，也就是主机间的 “一对一” 的通讯模式。

## 2.2.2 TCP 头部和封装

### 2.2.2.1 IP 数据报

![image](../../../images/ip-pack.jpg)

## TCP 滑动窗口

如果 TCP 每发一个段就要进行一次确认应答（ACK）的处理，这样子的传输方式就会导致包的往返时间越长，通信性能就越低。

![image](../../../images/no-screen.jpg)

如上图，对每一个数据包都进行了应答处理，这样子包的往返时间就会变长，开销自然也就变大了，整体的网络吞吐量就更差了。

为了解决这个问题，就出现了滑动窗口，将数据包在达到约定的窗口大小前，可以不断地进行发送，直至达到窗口上限，才需要进行等待应答（ACK）和相应的一系列（例如调整窗口大小）操作，而在收到应答后，就能继续发送数据包了：

![image](../../../images/screen.jpg)

上述所指的窗口大小代指在数据包传输中，无需每次传输都等待确认应答，在达到窗口上限前，可以不断发送数据包，直至最大值，也就是主机 A 可以不断发送 4000 字节的数据，然后才需要进行等待应答（ACK）。

那么是不是必须发满 4000 字节，再等到 4000 字节的空闲才能接着发送呢，其实不然，只要窗口大小有空余位置，就可以不断的发：

![image](../../../images/screen-not-slide.jpg)

在上图中，第一次的数据包段（1、2、3、4 号）发送后，已经将窗口大小用满了，因此在应答后，窗口最终又切到了新的数据包段（5、6、7、8 号）中，这似乎是预期中的 “完美” 情况。

但实际在真实环境中，它并不会这么运行，因为是 “滑动” 的，也就是可变的，并不是 4000 字节 4000 整的挪动窗口位置，而是有空闲就可以见缝插针：

![image](../../../images/screen-partial-slide.jpg)

在上图中，数据包 5、6 号已经应答，因此此时的窗口大小将还有 2000 字节，因此数据包 9、10 号将从缓冲区中被发出，变更为已发送（未应答）的状态，并且后续的数据包 11、12 号将进入到待发送的缓冲区中。

## TCP 拥塞控制

TCP 允许按窗口大小批量且不断地发送数据包，这时候又有一个新的问题，如果在网络出现拥塞时，如果突然发送一个较大量的数据，就极有可能会出现整个网络的瘫痪。因此 TCP 为了防止这个问题的出现，在通信一开始时就会通过一个慢启动的算法来计算一个数值，对发送的数据量进行控制。

### 慢启动

为了在发送端调节索要发送数据的量，发送端会维持一个 “拥塞窗口” 的概念。在慢启动的时候，会将初始的拥塞窗口的大小设置为 1 个数据段（1 MSS）来发送数据，之后每收到一次确认应答（ACK），拥塞窗口的值就会加 1。并且在发送数据包时，会将拥塞窗口的大小和接收端主机通知的窗口大小做比较，然后取两者中较小的值，发送比其还要小的数据量。

![image](../../../images/slow-start.jpg)

同时随着包的每次往返，拥塞窗口也会以 1、2、4 等指数函数的增长。而拥塞状况激增也会导致网络拥塞的发生，为了防止这个情况，TCP 引入了慢启动阈值的概念，只要当拥塞窗口的值超出这个阈值，在每收到一次确认应答时，就只允许按特定比例放大拥塞窗口。

### 拥塞避免

在慢启动中我们提到了 “随着包的每次往返，拥塞窗口也会以 1、2、4 等指数函数的增长”。这样子的话，我们可预估得知拥塞窗口的大小会呈直线上升。

### 快速重传

### 快速恢复


## TCP 重发机制

## TCP 是如何落实可靠性的